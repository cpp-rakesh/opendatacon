<!DOCTYPE html>
<html lang="en">
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>OpenDataCon</title>

    <link rel="stylesheet" href="/node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/node_modules/bootstrap_select/dist/css/bootstrap-select.css">

    <script src='node_modules/plot/plotly-latest.min.js'></script>
    <script src="node_modules/jquery/dist/jquery.min.js"></script>
    <script src="node_modules/popper/dist/umd/popper.min.js"></script>
    <script src="node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="node_modules/bootstrap_select/dist/js/bootstrap-select.min.js"></script>

    <script>
      $(function() {
          $("#common_content").load("common.html");
      });
    </script>
  </head>

  <body>
    <!-- html page starts from here -->
    <!-- html common loaded -->
    <div id="common_content"></div>

    <div class="alert alert-info clearfix">
      <a href="#" class="alert-link"></a>
      <button type="button" class="btn btn-primary float-right" onclick="go_to_tabular()">Tabular</button>
      <button type="button" class="btn btn-warning float-right" onclick="go_to_control_panel()">Control Panel</button>
      <button type="button" class="btn btn-info float-right" onclick="go_to_visualization()">Visualization</button>
      <button type="button" class="btn btn-success float-right" onclick="go_to_binary_controls()">Binary Controls</button>
    </div>

    <div class="container">
      <div class="row">

        <select class="selectpicker" data-live-search="true" id="select_ports" title="Ports">
        </select>
        &nbsp;&nbsp;

        <div class="btn-group" role="group">
          <button type="button" class="btn btn-primary" onclick="set_action()">On</button>
          <button type="button" class="btn btn-secondary" onclick="set_action()">Off</button>
        </div>
        &nbsp;&nbsp;

        <select class="selectpicker" data-live-search="true" id="select_name" title="Point Names">
        </select>
        &nbsp;&nbsp;

        <button type="button" class="btn btn-primary" onclick="send_event()">Send Event</button>
        &nbsp;&nbsp;
        <button type="button" class="btn btn-warning" onclick="configuration()">Confuguration</button>

      </div>
    </div>

    <div id="drawing_board"> <!-- Plotly drawing board for plots -->
    </div>
    <span class="badge badge-pill badge-primary float-xl-right">
      <div id="current_data">
      </div>
    </span>

    <script>
      var gport = null;
      var gnames = {};

      $(document).ready(function () {
          const url = "/SimControl List";
          $.post(url, {})
              .done(function (data) {
                  var options = [];
                  data['Items'].forEach(function (item) {
                      const option = '<option>' + item + '</option>';
                      options.push(option);
                  });

                  $('#select_ports').html(options);
                  $('#select_ports').selectpicker('refresh');
              })
      });

      function go_to_tabular() {
          window.location.href="index.html";
      }

      function go_to_control_panel() {
          window.location.href="control_panel.html";
      }

      function go_to_visualization() {
          window.location.href="visualization.html";
      }

      function go_to_binary_controls() {
          document.getElementById('binary_control_modal_title').innerHTML = 'Binary Controls';
          $('#binary_control_modal').modal('show');
      }

      $("#select_ports").on('changed.bs.select', function (e, index, new_value, old_value) {
          gnames = {};
          gport = $(e.currentTarget).val();
          const url = "/DataPorts Configuration";
          $.post(url, {Target : gport})
              .done(function (data) {
                  for (const [key, value] of Object.entries(data)) {
                      const k = gport.substr(4, gport.length - 4);
                      if (key.includes(k)) {
                          if (value['BinaryControls']) {
                              value['BinaryControls'].forEach(function (item) {
                                  if (item['FeedbackBinaries']) {
                                      item['FeedbackBinaries'].forEach(function (feedback) {
                                          if (feedback['FeedbackMode']) {
                                              if (feedback['FeedbackMode'].toLowerCase() == 'latch') {
                                                  node = {'Index' : feedback['Index'],
                                                          'OffValue' : null,
                                                          'OnValue' : null};
                                                  if (feedback['OffValue'])
                                                      node['OffValue'] = feedback['OffValue'];
                                                  if (feedback['OnValue'])
                                                      node['OnValue'] = feedback['OnValue'];
                                                  gnames[item['Name']].push(Node);
                                              }
                                          }
                                      });
                                  }
                              });
                          }
                      }
                  }
              });
          console.log(gnames);
      });

    </script>
  </body>
</html>
