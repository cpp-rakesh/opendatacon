<!DOCTYPE html>
<html lang="en">
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>OpenDataCon</title>

    <link rel="stylesheet" href="/node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/node_modules/bootstrap_select/dist/css/bootstrap-select.css">

    <script src="/node_modules/jquery/dist/jquery.min.js"></script>
    <script src="/node_modules/popper/dist/umd/popper.min.js"></script>
    <script src="/node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="/node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/node_modules/bootstrap_select/dist/js/bootstrap-select.min.js"></script>
  </head>

  <body>
    <!-- html section -->
    <div class="alert alert-info clearfix">
      <div class"container">
        <div class="row">
          <a href="#" class="alert-link"></a>
          <div class="col-sm-4">
            <select class="selectpicker" multiple data-live-search="true" id="select_ports" title="Ports">
            </select>
          </div>

          <div class="col-sm-4">
            <div class="dropdown" id="dropdown_point_type">
              <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
                Point Type
              </button>

              <div class="dropdown-menu">
                <a class="dropdown-item" onclick="set_point_type('Analog')">Analog</a>
                <a class="dropdown-item" onclick="set_point_type('Binary')">Binary</a>
              </div>
            </div>
          </div>

          <div class="col-sm-4">
            <select class="selectpicker" multiple data-live-search="true" id="select_names" title="Names">
            </select>
          </div>

        </div>
      </div>
    </div>

    <script>
      // global variables
      gpoint_type = null;
      gnames = {"Analog" : {}, "Binary" : {}};

      $(document).ready(function() {
          const url = "/SimControl List";
          $.post(url, {})
              .done(function (data) {
                  const ports = data["Items"];
                  var options = [];
                  ports.forEach(function (item) {
                      var option = "<option>" + item + "</option>";
                      options.push(option);
                  });

                  $('#select_ports').html(options);
                  $('#select_ports').selectpicker('refresh');
              });
      });

      function populate_names(point_type) {
          gpoint_type = point_type;
      }

      $('#select_ports').on('changed.bs.select', function(e, index, new_value, old_value) {
          gnames = {"Analog" : {}, "Binary" : {}};
          const ports = $(e.currentTarget).val().join(",");
          ports.split(",").forEach(function (port) {
              if (port.length > 0) {
                  const url = "/DataPorts Configuration";
                  $.post(url, {Target : port})
                      .done(function (data) {
                          for (const [key, value] of Object.entries(data)) {
                              const k = port.substr(4, port.length - 4);
                              if (key.includes(k)) {
                                  const analogs = value["Analogs"];
                                  analogs.forEach(function (item) {
                                      gnames["Analog"][item.Name] = item.Index;
                                  });
                                  const binaries = value["Binaries"];
                                  binaries.forEach(function (item) {
                                      gnames["Binary"][item.Name] = item.Index;
                                  });
                              }
                          }
                      });
              }
          });

          console.log(gnames);
      });
    </script>
  </body>
</html>
