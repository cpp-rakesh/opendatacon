<!DOCTYPE html>
<html lang="en">
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>OpenDataCon</title>

    <link rel="stylesheet" href="/node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/node_modules/bootstrap_select/dist/css/bootstrap-select.css">

    <script src='node_modules/plot/plotly-latest.min.js'></script>
    <script src="node_modules/jquery/dist/jquery.min.js"></script>
    <script src="node_modules/popper/dist/umd/popper.min.js"></script>
    <script src="node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="node_modules/bootstrap_select/dist/js/bootstrap-select.min.js"></script>
  </head>

  <body>
    <!-- html page starts from here -->

    <div class="alert alert-info clearfix">
      <a href="#" class="alert-link"></a>
      <button type="button" class="btn btn-primary float-right" onclick="go_to_tabular()">Tabular</button>
      <button type="button" class="btn btn-warning float-right" onclick="go_to_control_panel()">Control Panel</button>
      <button type="button" class="btn btn-info float-right" onclick="go_to_binary_controls()">Binary Controls</button>
    </div>

    <div class="container">
      <div class="row">

        <div class="col-sm-3">
          <select class="selectpicker" data-live-search="true" id="select_ports" title="Ports">
          </select>
        </div>

        <div class="col-sm-4">
          <div class="dropdown" id="dropdown_point_type">
            <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
              Point Type
            </button>

            <div class="dropdown-menu">
              <a class="dropdown-item" onclick="populate_names('Analog')">Analog</a>
              <a class="dropdown-item" onclick="populate_names('Binary')">Binary</a>
            </div>
          </div>
        </div>

        <div class="col-sm-4">
          <select class="selectpicker" data-live-search="true" id="select_name" title="Point Names">
          </select>
        </div>

      </div>
    </div>

    <div id="drawing_board"> <!-- Plotly drawing board for plots -->
    </div>
    <span class="badge badge-pill badge-primary float-xl-right">
      <div id="current_data">
      </div>
    </span>

    <script>
      var gpayload = [];
      var gtimestamp = [];
      var gtype = "";
      var gport = "";
      var gnames = {"Analog" : {}, "Binary" : {}};
      var gtimer_handle = null;

      $(document).ready(function() {
          const url = "/SimControl List";
          $.post(url, {})
              .done(function (data) {
                  const ports = data["Items"];
                  var options = [];
                  ports.forEach(function(item) {
                      const option = "<option>" + item + "</option>";
                      options.push(option);
                  });

                  $("#select_ports").html(options);
                  $("#select_ports").selectpicker("refresh");
              });
      });

      function go_to_tabular() {
          window.location.href="index.html";
      }

      function go_to_control_panel() {
          window.location.href="control_panel.html";
      }

      function go_to_binary_controls() {
          console.log('Binary Controls TBD');
      }

      function populate_names(type) {
          gtype = type;
          var options = [];
          for (const [key, value] of Object.entries(gnames[gtype])) {
              const option = "<option>" + key + "</option>";
              options.push(option);
          }
          $("#select_name").html(options);
          $("#select_name").selectpicker("refresh");
      }

      function plot(index) {
          const url = "/DataPorts CurrentState";
          $.post(url, {Target : gport})
              .done(function (data) {
                  if (gpayload.length >= 50) {
                      gpayload.shift();
                      gtimestamp.shift();
                  }
                  const v = data[gtype + "Timestamp"][index] + " : " + data[gtype + "Payload"][index];
                  document.getElementById("current_data").innerHTML = v;
                  gpayload.push(data[gtype + "Payload"][index]);
                  gtimestamp.push(data[gtype + "Timestamp"][index].substr(14, 5));
              });
          const data = [ {
              x: gtimestamp,
              y: gpayload,
              type: 'scatter',
              mode: 'lines+markers',
              marker: {
                  color: 'rgb(128, 0, 128)',
                  size: 8
              }
          } ];
          Plotly.newPlot('drawing_board', data);
      }

      $("#select_ports").on('changed.bs.select', function (e, index, new_value, old_value) {
          gnames = {"Analog" : {}, "Binary" : {}};
          gport = $(e.currentTarget).val();
          const url = "DataPorts Configuration";
          $.post(url, {Target : gport})
              .done(function (data) {
                  for (const [key, value] of Object.entries(data)) {
                      const k = gport.substr(4, gport.length - 4);
                      if (key.includes(k)) {
                          const analogs = value["Analogs"];
                          value["Analogs"].forEach(function (item) {
                              gnames["Analog"][item.Name] = item.Index;
                          });
                          value["Binaries"].forEach(function (item) {
                              gnames["Binary"][item.Name] = item.Index;
                          });
                      }
                  }
              });
      });

      $("#select_name").on('changed.bs.select', function (e, index, new_value, old_value) {
          gpayload = [];
          gtimestamp = [];
          const selected = $(e.currentTarget).val();
          const ind = gnames[gtype][selected];
          gtimer_handle = window.setInterval(function() { plot(ind); }, 2000);
      });

      </script>
  </body>
</html>
