<!DOCTYPE html>
<html lang="en">
<html>
  <head>
    <meta charset="utf-8"/>
    <title>OpenDataCon</title>

    <link rel="stylesheet" href="/node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel = "stylesheet" href="/node_modules/bootstrap_select/dist/css/bootstrap-select.css" />

    <script src="/node_modules/jquery/dist/jquery.min.js"></script>
    <script src="/node_modules/plotly/plotly-latest.min.js"></script>
    <script src="/node_modules/popper/dist/umd/popper.min.js"></script>
    <script src="/node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src= "/node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src= "/node_modules/bootstrap_select/dist/js/bootstrap-select.min.js"></script>

    <script>
      $(function() {
          $('select').selectpicker();
      });
    </script>
  </head>

  <body>

    <div class="row">
      <div class="col-sm-3">
        <div class="dropdown" id="point_type_dropdown">
          <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
            Point Type
          </button>

          <div class="dropdown-menu">
            <a class="dropdown-item" onclick="set_point_type('AnalogCurrent')">Analog</a>
            <a class="dropdown-item" onclick="set_point_type('BinaryCurrent')">Binary</a>
          </div>
        </div>
      </div>

      <div class="col-sm-3">
        <select class="selectpicker" data-live-search="true" id="index_select" title="Indexes">
        </select>
      </div>

      <div class="col-sm-3">
        <button type="button" class="btn btn-primary" id = "plot_button" onclick="plot();">
          Plot
        </button>
      </div>

      <div class="col-sm-3">
        <div class="alert alert-primary">
          <strong>
            <div id="point_value">
            </div>
          </strong>
        </div>
      </div>
    </div>

    <script>
      var gtarget = null;
      var gtype = null;
      var gindex = null;
      const ganalog = "AnalogCurrent";
      const gbinary = "BinaryCurrent";
      var gindexes = {};
      var gtimestamps = {"AnalogCurrent" : [], "BinaryCurrent" : []};
      var gpayloads = {"AnalogCurrent" : [], "BinaryCurrent" : []};
      $(document).ready(function() {
          gtarget = new URL(window.location.href).searchParams.get('target');
          init();
      });

      function init() {
          const url = "/DataPorts CurrentState";
          $.post( url, { Target : gtarget } )
              .done(function( data ) {
                  var analogs = data[ganalog];
                  var indexes = [];
                  for (const [key, value] of Object.entries(analogs)) {
                      indexes.push(key);
                      var ts = [];
                      ts.push(now());
                      gtimestamps[ganalog].push({
                          key: key,
                          value: ts
                      });
                      var val = [];
                      val.push(value);
                      gpayloads[ganalog].push({
                          key: key,
                          value: val
                      });
                  }
                  gindexes[ganalog] = indexes;

                  var indexes = [];
                  var binaries = data[gbinary];
                  for (const [key, value] of Object.entries(binaries)) {
                      indexes.push(key);
                      var ts = [];
                      ts.push(now());
                      gtimestamps[gbinary].push({
                          key: key,
                          value: ts
                      });
                      var val = [];
                      val.push(value);
                      gpayloads[gbinary].push({
                          key: key,
                          value: val
                      });
                  }
                  gindexes[gbinary] = indexes;
              });
      }

      function now() {
          const now = new Date();
          const time = now.getHours() + ":"
                + now.getMinutes() + ":"
                + now.getSeconds();
          return time;
      }

      function plot() {
          window.setInterval(function() { refresh_data(); }, 1000);
      }

      function refresh_data() {
          const url = "/DataPorts CurrentState";
          $.post( url, { Target : gtarget } )
              .done(function( data ) {
                  var analogs = data[ganalog];
                  for (const [key, value] of Object.entries(analogs)) {
                      gtimestamps[ganalog][key].push(now());
                      gpayloads[ganalog][key].push(value);
                  }

                  var binaries = data[gbinary];
                  for (const [key, value] of Object.entries(binaries)) {
                      gtimestamps[gbinary][key].push(now());
                      gpayloads[gbinary][key].push(value);
                  }
              });
          var arr = gpayloads[gtype][gindex];
          document.getElementById('point_value').innerHTML = arr[arr.length - 1];
      }

      function set_point_type(type) {
          gtype = type;
          var indexes = [];
          if (type == ganalog)
              indexes = gindexes[ganalog];
          if (type == gbinary)
              indexes = gindexes[gbinary];

          var options = [];
          indexes.forEach(function (item) {
              var option = "<option>" + item + "</option>"
              options.push(option);
          });

          $('#index_select').html(options);
          $('#index_select').selectpicker('refresh');
      }

      $('#index_select').on('changed.bs.select', function (e, index, new_value, old_value) {
          gindex = $(e.currentTarget).val();
      });
    </script>
  </body>
</html>

